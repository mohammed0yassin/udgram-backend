---
- name: Playbook to get ASG EC2 Hosts
  hosts: localhost
  gather_facts: false
  become: false


  tasks:

      
  - name: Find a group with matching name/prefix
    ec2_asg_info:
    name: WebServer
    register: asg_ec2_instance_ids
  # - debug: var=asg_ec2_instance_ids.results[0].instances|map(attribute='instance_id')|list

  - name: Group Hosts
    ec2_instance_info:
      instance_ids: '{{ item }}'
    with_items: "{{ asg_ec2_instance_ids.results[0].instances|map(attribute='instance_id')|list }}"
    register: ec2s
  # - debug: var=ec2s.results|map(attribute='instances')|sum(start=[])|map(attribute='network_interfaces')|sum(start=[])|map(attribute='private_dns_name')|list

  - name: Group Hosts
    add_host: hostname={{ item }} groups=backendservers
    with_items: "{{ ec2s.results|map(attribute='instances')|sum(start=[])|map(attribute='network_interfaces')|sum(start=[])|map(attribute='private_dns_name')|list }}"

- name: playbook deploy the node backend
  hosts: backendservers
  gather_facts: false
  become: true
  environment:
    POSTGRES_USERNAME: "{{ POSTGRES_USERNAME }}"
    POSTGRES_PASSWORD: "{{ POSTGRES_PASSWORD }}"
    POSTGRES_HOST: "{{ POSTGRES_HOST }}" 
    POSTGRES_DB: "{{ POSTGRES_DB }}"
    PORT: "{{ PORT }}"
    JWT_SECRET: "{{ JWT_SECRET }}"

  tasks:
  - set_fact:
      ansible_ssh_common_args: -o ProxyCommand="ssh -q ubuntu@ec2-50-19-135-207.compute-1.amazonaws.com -W %h:%p"
      ansible_user: ubuntu
      
  - name: Stop current running server
    shell:
      cmd: killall node
    ignore_errors: yes

  - name: Clean old server files
    shell:
      cmd: rm -rf Archive.zip node_modules/ package*.json www/
      chdir: /var/app/current/

  - name: Copy Build Zip File
    copy:
      src: ./Archive.zip
      dest: /var/app/current
  
  - name: Unzip Build File
    shell:
      cmd: unzip Archive.zip
      chdir: /var/app/current/

  - name: Install node_modules
    shell:
      cmd: npm install
      chdir: /var/app/current/

  - name: Start the server
    shell:
      cmd: npm run start &
      chdir: /var/app/current/
